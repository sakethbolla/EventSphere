name: CI Pipeline (PR)

# PR workflow: Security Scan → Build and Sign Images
# Deployment validation happens on main branch via separate workflows
# This keeps PR checks fast while ensuring full validation before production

on:
  pull_request:
    branches:
      - main
    paths-ignore:
      - '*.md'
      - '**/*.md'

env:
  GHCR_REGISTRY: ghcr.io
  REGISTRY: ghcr.io
  IMAGE_PREFIX: ${{ github.repository }}

jobs:
  security-scan:
    name: Security Scan
    runs-on: ubuntu-latest
    permissions:
      contents: read
      security-events: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Trivy
        run: |
          sudo apt-get update
          sudo apt-get install wget apt-transport-https gnupg lsb-release -y
          wget -qO - https://aquasecurity.github.io/trivy-repo/deb/public.key | sudo apt-key add -
          echo "deb https://aquasecurity.github.io/trivy-repo/deb $(lsb_release -sc) main" | sudo tee -a /etc/apt/sources.list.d/trivy.list
          sudo apt-get update
          sudo apt-get install trivy -y
          trivy --version

      - name: Run Trivy filesystem scan (show vulnerabilities)
        id: trivy-fs-table
        continue-on-error: true
        run: |
          echo "Running Trivy filesystem scan - showing CRITICAL vulnerabilities..."
          echo "Note: Documentation files (*.md) excluded from scan"
          echo "=========================================="
          trivy fs . --severity CRITICAL --format table --skip-files '*.md' --exit-code 0 || true
          echo "=========================================="

      - name: Run Trivy filesystem scan (SARIF for GitHub)
        id: trivy-fs
        continue-on-error: true
        run: |
          trivy fs . --severity CRITICAL --format sarif --output trivy-fs-results.sarif --skip-files '*.md' --exit-code 1 || true
      
      - name: Show filesystem scan summary
        if: steps.trivy-fs.outcome == 'failure'
        run: |
          echo "CRITICAL vulnerabilities found in filesystem scan"
          echo "See the table output above for details"
          echo "Full results uploaded to GitHub Security tab"

      - name: Run Trivy Kubernetes and Dockerfile scan (show vulnerabilities)
        id: trivy-config-table
        continue-on-error: true
        run: |
          echo "Running Trivy config scan - showing CRITICAL vulnerabilities..."
          echo "Note: RBAC files (k8s/base/rbac.yaml) excluded from scan"
          echo "  Reason: Intentionally permissive roles for class project demonstration"
          echo "=========================================="
          trivy config . --severity CRITICAL --format table --skip-files k8s/base/rbac.yaml --exit-code 0 || true
          echo "=========================================="

      - name: Run Trivy Kubernetes and Dockerfile scan (SARIF for GitHub)
        id: trivy-config
        continue-on-error: true
        run: |
          trivy config . --severity CRITICAL --format sarif --output trivy-config-results.sarif --skip-files k8s/base/rbac.yaml --exit-code 1 || true
      
      - name: Show config scan summary
        if: steps.trivy-config.outcome == 'failure'
        run: |
          echo "CRITICAL vulnerabilities found in config scan"
          echo "See the table output above for details"
          echo "Full results uploaded to GitHub Security tab"

      - name: Run Checkov infrastructure scan
        uses: bridgecrewio/checkov-action@master
        with:
          directory: infrastructure/
          framework: cloudformation,terraform,kubernetes
          output_format: sarif
          output_file_path: checkov-results.sarif
          soft_fail: true

      - name: Check for SARIF files
        id: sarif-check
        continue-on-error: true
        run: |
          echo "Checking for SARIF files..."
          [ -f trivy-fs-results.sarif ] && echo "trivy-fs-exists=true" >> $GITHUB_OUTPUT || echo "trivy-fs-exists=false" >> $GITHUB_OUTPUT
          [ -f trivy-config-results.sarif ] && echo "trivy-config-exists=true" >> $GITHUB_OUTPUT || echo "trivy-config-exists=false" >> $GITHUB_OUTPUT
          [ -f checkov-results.sarif ] && echo "checkov-exists=true" >> $GITHUB_OUTPUT || echo "checkov-exists=false" >> $GITHUB_OUTPUT

      - name: Upload Trivy filesystem scan results
        uses: github/codeql-action/upload-sarif@v4
        continue-on-error: true
        with:
          sarif_file: trivy-fs-results.sarif
          wait-for-processing: false
        if: always() && steps.sarif-check.outputs.trivy-fs-exists == 'true'

      - name: Upload Trivy config scan results
        uses: github/codeql-action/upload-sarif@v4
        continue-on-error: true
        with:
          sarif_file: trivy-config-results.sarif
          wait-for-processing: false
        if: always() && steps.sarif-check.outputs.trivy-config-exists == 'true'

      - name: Upload Checkov scan results
        uses: github/codeql-action/upload-sarif@v4
        continue-on-error: true
        with:
          sarif_file: checkov-results.sarif
          wait-for-processing: false
        if: always() && steps.sarif-check.outputs.checkov-exists == 'true'

  build-and-push:
    name: Build and Push Images
    runs-on: ubuntu-latest
    needs: security-scan  # Only run after security-scan succeeds
    if: success()  # Only run if security-scan job succeeded
    permissions:
      contents: read
      packages: write
      id-token: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.pull_request.head.sha }}

      - name: Set lowercase image prefix
        id: image-prefix
        run: |
          echo "prefix=$(echo '${{ github.repository }}' | tr '[:upper:]' '[:lower:]')" >> $GITHUB_OUTPUT

      - name: Set image tag
        id: set-tag
        run: |
          # Use commit SHA for PRs
          echo "tag=${{ github.event.pull_request.head.sha }}" >> $GITHUB_OUTPUT

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.GHCR_REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build and push auth-service
        uses: docker/build-push-action@v5
        with:
          context: ./services/auth-service
          file: ./services/auth-service/Dockerfile
          push: true
          tags: |
            ${{ env.GHCR_REGISTRY }}/${{ steps.image-prefix.outputs.prefix }}/auth-service:${{ steps.set-tag.outputs.tag }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
          platforms: linux/amd64

      - name: Build and push event-service
        uses: docker/build-push-action@v5
        with:
          context: ./services/event-service
          file: ./services/event-service/Dockerfile
          push: true
          tags: |
            ${{ env.GHCR_REGISTRY }}/${{ steps.image-prefix.outputs.prefix }}/event-service:${{ steps.set-tag.outputs.tag }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
          platforms: linux/amd64

      - name: Build and push booking-service
        uses: docker/build-push-action@v5
        with:
          context: ./services/booking-service
          file: ./services/booking-service/Dockerfile
          push: true
          tags: |
            ${{ env.GHCR_REGISTRY }}/${{ steps.image-prefix.outputs.prefix }}/booking-service:${{ steps.set-tag.outputs.tag }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
          platforms: linux/amd64

      - name: Build and push frontend
        uses: docker/build-push-action@v5
        with:
          context: ./frontend
          file: ./frontend/Dockerfile
          push: true
          tags: |
            ${{ env.GHCR_REGISTRY }}/${{ steps.image-prefix.outputs.prefix }}/frontend:${{ steps.set-tag.outputs.tag }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
          platforms: linux/amd64

      - name: Run Trivy vulnerability scanner on auth-service
        continue-on-error: true
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: ${{ env.GHCR_REGISTRY }}/${{ steps.image-prefix.outputs.prefix }}/auth-service:${{ steps.set-tag.outputs.tag }}
          format: 'sarif'
          output: 'trivy-auth-service.sarif'
          exit-code: '0'  # Don't fail here, we'll check the SARIF file

      - name: Display auth-service vulnerabilities
        run: |
          if [ -f trivy-auth-service.sarif ]; then
            echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
            echo "Vulnerability Report: auth-service"
            echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
            
            # Extract and display vulnerabilities in a readable format
            VULN_COUNT=$(jq '.runs[0].results | length' trivy-auth-service.sarif 2>/dev/null || echo "0")
            if [ "$VULN_COUNT" -eq 0 ]; then
              echo "No vulnerabilities found"
            else
              jq -r '.runs[0].results[] | 
                "\n======================================================================\n" +
                "Severity: " + (try (.message.text | capture("Severity: (?<sev>[A-Z]+)") | .sev) catch "UNKNOWN") + "\n" +
                "CVE ID: " + .ruleId + "\n" +
                (.message.text | split("\n") | map(select(. != "")) | .[] | "  " + .) + "\n"' \
                trivy-auth-service.sarif 2>/dev/null || echo "Unable to parse SARIF"
            fi
            echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
            
            # Check for CRITICAL vulnerabilities
            CRITICAL_COUNT=$(jq '[.runs[0].results[] | select(.message.text | contains("Severity: CRITICAL"))] | length' trivy-auth-service.sarif 2>/dev/null || echo "0")
            if [ "$CRITICAL_COUNT" -gt 0 ]; then
              echo ""
              echo "CRITICAL vulnerabilities found in auth-service!"
              exit 1
            else
              echo ""
              echo "No CRITICAL vulnerabilities found in auth-service"
            fi
          else
            echo "WARNING: SARIF file not found, skipping check"
          fi

      - name: Run Trivy vulnerability scanner on event-service
        continue-on-error: true
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: ${{ env.GHCR_REGISTRY }}/${{ steps.image-prefix.outputs.prefix }}/event-service:${{ steps.set-tag.outputs.tag }}
          format: 'sarif'
          output: 'trivy-event-service.sarif'
          exit-code: '0'  # Don't fail here, we'll check the SARIF file

      - name: Display event-service vulnerabilities
        run: |
          if [ -f trivy-event-service.sarif ]; then
            echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
            echo "Vulnerability Report: event-service"
            echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
            
            jq -r '.runs[0].results[] | 
              "Severity: " + (.message.text | capture("Severity: (?<sev>[A-Z]+)") | .sev // "UNKNOWN") + "\n" +
              "CVE: " + .ruleId + "\n" +
              (.message.text | split("\n") | map(select(. != "")) | .[] | "  " + .) + "\n" +
              "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"' \
              trivy-event-service.sarif 2>/dev/null || echo "No vulnerabilities found or unable to parse SARIF"
            
            CRITICAL_COUNT=$(jq '[.runs[0].results[] | select(.message.text | contains("Severity: CRITICAL"))] | length' trivy-event-service.sarif 2>/dev/null || echo "0")
            if [ "$CRITICAL_COUNT" -gt 0 ]; then
              echo ""
              echo "CRITICAL vulnerabilities found in event-service!"
              exit 1
            else
              echo ""
              echo "No CRITICAL vulnerabilities found in event-service"
            fi
          else
            echo "WARNING: SARIF file not found, skipping check"
          fi

      - name: Run Trivy vulnerability scanner on booking-service
        continue-on-error: true
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: ${{ env.GHCR_REGISTRY }}/${{ steps.image-prefix.outputs.prefix }}/booking-service:${{ steps.set-tag.outputs.tag }}
          format: 'sarif'
          output: 'trivy-booking-service.sarif'
          exit-code: '0'  # Don't fail here, we'll check the SARIF file

      - name: Display booking-service vulnerabilities
        run: |
          if [ -f trivy-booking-service.sarif ]; then
            echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
            echo "Vulnerability Report: booking-service"
            echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
            
            jq -r '.runs[0].results[] | 
              "Severity: " + (.message.text | capture("Severity: (?<sev>[A-Z]+)") | .sev // "UNKNOWN") + "\n" +
              "CVE: " + .ruleId + "\n" +
              (.message.text | split("\n") | map(select(. != "")) | .[] | "  " + .) + "\n" +
              "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"' \
              trivy-booking-service.sarif 2>/dev/null || echo "No vulnerabilities found or unable to parse SARIF"
            
            CRITICAL_COUNT=$(jq '[.runs[0].results[] | select(.message.text | contains("Severity: CRITICAL"))] | length' trivy-booking-service.sarif 2>/dev/null || echo "0")
            if [ "$CRITICAL_COUNT" -gt 0 ]; then
              echo ""
              echo "CRITICAL vulnerabilities found in booking-service!"
              exit 1
            else
              echo ""
              echo "No CRITICAL vulnerabilities found in booking-service"
            fi
          else
            echo "WARNING: SARIF file not found, skipping check"
          fi

      - name: Run Trivy vulnerability scanner on frontend
        continue-on-error: true
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: ${{ env.GHCR_REGISTRY }}/${{ steps.image-prefix.outputs.prefix }}/frontend:${{ steps.set-tag.outputs.tag }}
          format: 'sarif'
          output: 'trivy-frontend.sarif'
          exit-code: '0'  # Don't fail here, we'll check the SARIF file

      - name: Display frontend vulnerabilities
        run: |
          if [ -f trivy-frontend.sarif ]; then
            echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
            echo "Vulnerability Report: frontend"
            echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
            
            jq -r '.runs[0].results[] | 
              "Severity: " + (.message.text | capture("Severity: (?<sev>[A-Z]+)") | .sev // "UNKNOWN") + "\n" +
              "CVE: " + .ruleId + "\n" +
              (.message.text | split("\n") | map(select(. != "")) | .[] | "  " + .) + "\n" +
              "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"' \
              trivy-frontend.sarif 2>/dev/null || echo "No vulnerabilities found or unable to parse SARIF"
            
            CRITICAL_COUNT=$(jq '[.runs[0].results[] | select(.message.text | contains("Severity: CRITICAL"))] | length' trivy-frontend.sarif 2>/dev/null || echo "0")
            if [ "$CRITICAL_COUNT" -gt 0 ]; then
              echo ""
              echo "CRITICAL vulnerabilities found in frontend!"
              exit 1
            else
              echo ""
              echo "No CRITICAL vulnerabilities found in frontend"
            fi
          else
            echo "WARNING: SARIF file not found, skipping check"
          fi

      - name: Check for Trivy SARIF files
        id: trivy-sarif-check
        continue-on-error: true
        run: |
          echo "Checking for Trivy SARIF files..."
          [ -f trivy-auth-service.sarif ] && echo "auth-exists=true" >> $GITHUB_OUTPUT || echo "auth-exists=false" >> $GITHUB_OUTPUT
          [ -f trivy-event-service.sarif ] && echo "event-exists=true" >> $GITHUB_OUTPUT || echo "event-exists=false" >> $GITHUB_OUTPUT
          [ -f trivy-booking-service.sarif ] && echo "booking-exists=true" >> $GITHUB_OUTPUT || echo "booking-exists=false" >> $GITHUB_OUTPUT
          [ -f trivy-frontend.sarif ] && echo "frontend-exists=true" >> $GITHUB_OUTPUT || echo "frontend-exists=false" >> $GITHUB_OUTPUT

      - name: Upload Trivy auth-service results
        if: always() && steps.trivy-sarif-check.outputs.auth-exists == 'true'
        uses: github/codeql-action/upload-sarif@v4
        continue-on-error: true
        with:
          sarif_file: trivy-auth-service.sarif
          wait-for-processing: false

      - name: Upload Trivy event-service results
        if: always() && steps.trivy-sarif-check.outputs.event-exists == 'true'
        uses: github/codeql-action/upload-sarif@v4
        continue-on-error: true
        with:
          sarif_file: trivy-event-service.sarif
          wait-for-processing: false

      - name: Upload Trivy booking-service results
        if: always() && steps.trivy-sarif-check.outputs.booking-exists == 'true'
        uses: github/codeql-action/upload-sarif@v4
        continue-on-error: true
        with:
          sarif_file: trivy-booking-service.sarif
          wait-for-processing: false

      - name: Upload Trivy frontend results
        if: always() && steps.trivy-sarif-check.outputs.frontend-exists == 'true'
        uses: github/codeql-action/upload-sarif@v4
        continue-on-error: true
        with:
          sarif_file: trivy-frontend.sarif
          wait-for-processing: false

      - name: Install Cosign
        uses: sigstore/cosign-installer@v3
        with:
          cosign-release: 'v2.2.1'

      - name: Sign auth-service image
        env:
          IMAGE_REF: ${{ env.GHCR_REGISTRY }}/${{ steps.image-prefix.outputs.prefix }}/auth-service:${{ steps.set-tag.outputs.tag }}
        run: |
          echo "Signing image: ${IMAGE_REF}"
          cosign sign --yes ${IMAGE_REF}

      - name: Sign event-service image
        env:
          IMAGE_REF: ${{ env.GHCR_REGISTRY }}/${{ steps.image-prefix.outputs.prefix }}/event-service:${{ steps.set-tag.outputs.tag }}
        run: |
          echo "Signing image: ${IMAGE_REF}"
          cosign sign --yes ${IMAGE_REF}

      - name: Sign booking-service image
        env:
          IMAGE_REF: ${{ env.GHCR_REGISTRY }}/${{ steps.image-prefix.outputs.prefix }}/booking-service:${{ steps.set-tag.outputs.tag }}
        run: |
          echo "Signing image: ${IMAGE_REF}"
          cosign sign --yes ${IMAGE_REF}

      - name: Sign frontend image
        env:
          IMAGE_REF: ${{ env.GHCR_REGISTRY }}/${{ steps.image-prefix.outputs.prefix }}/frontend:${{ steps.set-tag.outputs.tag }}
        run: |
          echo "Signing image: ${IMAGE_REF}"
          cosign sign --yes ${IMAGE_REF}

      - name: Output image tags
        run: |
          echo "Built and pushed images with tag: ${{ steps.set-tag.outputs.tag }}"
          echo ""
          echo "Images pushed to GHCR (signed):"
          echo "  - ${{ env.GHCR_REGISTRY }}/${{ steps.image-prefix.outputs.prefix }}/auth-service:${{ steps.set-tag.outputs.tag }}"
          echo "  - ${{ env.GHCR_REGISTRY }}/${{ steps.image-prefix.outputs.prefix }}/event-service:${{ steps.set-tag.outputs.tag }}"
          echo "  - ${{ env.GHCR_REGISTRY }}/${{ steps.image-prefix.outputs.prefix }}/booking-service:${{ steps.set-tag.outputs.tag }}"
          echo "  - ${{ env.GHCR_REGISTRY }}/${{ steps.image-prefix.outputs.prefix }}/frontend:${{ steps.set-tag.outputs.tag }}"

