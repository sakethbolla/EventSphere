# Network Policies for service isolation
# Only allow necessary inter-service communication

---
# Network Policy for auth-service
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: auth-service-netpol
  namespace: prod
spec:
  podSelector:
    matchLabels:
      app: auth-service
  policyTypes:
  - Ingress
  - Egress
  ingress:
  # Allow ingress from frontend
  - from:
    - podSelector:
        matchLabels:
          app: frontend
    ports:
    - protocol: TCP
      port: 4001
  # Allow ingress from other services that need auth
  - from:
    - podSelector:
        matchLabels:
          app: event-service
    ports:
    - protocol: TCP
      port: 4001
  - from:
    - podSelector:
        matchLabels:
          app: booking-service
    ports:
    - protocol: TCP
      port: 4001
  # Allow ingress from ALB
  - from:
    - namespaceSelector:
        matchLabels:
          name: kube-system
    ports:
    - protocol: TCP
      port: 4001
  egress:
  # Allow egress to MongoDB
  - to:
    - podSelector:
        matchLabels:
          app: mongodb
    ports:
    - protocol: TCP
      port: 27017
  # Allow DNS
  - to:
    - namespaceSelector: {}
    ports:
    - protocol: UDP
      port: 53
  # Allow HTTPS for external APIs (if needed)
  - to: []
    ports:
    - protocol: TCP
      port: 443

---
# Network Policy for event-service
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: event-service-netpol
  namespace: prod
spec:
  podSelector:
    matchLabels:
      app: event-service
  policyTypes:
  - Ingress
  - Egress
  ingress:
  - from:
    - podSelector:
        matchLabels:
          app: frontend
    ports:
    - protocol: TCP
      port: 4002
  - from:
    - podSelector:
        matchLabels:
          app: booking-service
    ports:
    - protocol: TCP
      port: 4002
  - from:
    - namespaceSelector:
        matchLabels:
          name: kube-system
    ports:
    - protocol: TCP
      port: 4002
  egress:
  - to:
    - podSelector:
        matchLabels:
          app: mongodb
    ports:
    - protocol: TCP
      port: 27017
  - to:
    - podSelector:
        matchLabels:
          app: auth-service
    ports:
    - protocol: TCP
      port: 4001
  - to:
    - namespaceSelector: {}
    ports:
    - protocol: UDP
      port: 53

---
# Network Policy for booking-service
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: booking-service-netpol
  namespace: prod
spec:
  podSelector:
    matchLabels:
      app: booking-service
  policyTypes:
  - Ingress
  - Egress
  ingress:
  - from:
    - podSelector:
        matchLabels:
          app: frontend
    ports:
    - protocol: TCP
      port: 4003
  - from:
    - namespaceSelector:
        matchLabels:
          name: kube-system
    ports:
    - protocol: TCP
      port: 4003
  egress:
  - to:
    - podSelector:
        matchLabels:
          app: mongodb
    ports:
    - protocol: TCP
      port: 27017
  - to:
    - podSelector:
        matchLabels:
          app: auth-service
    ports:
    - protocol: TCP
      port: 4001
  - to:
    - podSelector:
        matchLabels:
          app: event-service
    ports:
    - protocol: TCP
      port: 4002
  - to:
    - namespaceSelector: {}
    ports:
    - protocol: UDP
      port: 53

---
# Network Policy for frontend
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: frontend-netpol
  namespace: prod
spec:
  podSelector:
    matchLabels:
      app: frontend
  policyTypes:
  - Ingress
  - Egress
  ingress:
  # Allow ingress from ALB/Ingress
  - from:
    - namespaceSelector:
        matchLabels:
          name: kube-system
    ports:
    - protocol: TCP
      port: 80
  egress:
  # Allow egress to all backend services
  - to:
    - podSelector:
        matchLabels:
          app: auth-service
    ports:
    - protocol: TCP
      port: 4001
  - to:
    - podSelector:
        matchLabels:
          app: event-service
    ports:
    - protocol: TCP
      port: 4002
  - to:
    - podSelector:
        matchLabels:
          app: booking-service
    ports:
    - protocol: TCP
      port: 4003
  # Allow DNS
  - to:
    - namespaceSelector: {}
    ports:
    - protocol: UDP
      port: 53

---
# Network Policy for MongoDB
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: mongodb-netpol
  namespace: prod
spec:
  podSelector:
    matchLabels:
      app: mongodb
  policyTypes:
  - Ingress
  - Egress
  ingress:
  # Only allow ingress from backend services
  - from:
    - podSelector:
        matchLabels:
          app: auth-service
    ports:
    - protocol: TCP
      port: 27017
  - from:
    - podSelector:
        matchLabels:
          app: event-service
    ports:
    - protocol: TCP
      port: 27017
  - from:
    - podSelector:
        matchLabels:
          app: booking-service
    ports:
    - protocol: TCP
      port: 27017
  egress:
  # Allow DNS
  - to:
    - namespaceSelector: {}
    ports:
    - protocol: UDP
      port: 53




