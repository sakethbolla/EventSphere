apiVersion: kyverno.io/v1
kind: ClusterPolicy
metadata:
  name: require-non-root-user
  annotations:
    policies.kyverno.io/title: "Require Non-Root User"
    policies.kyverno.io/category: "Security"
    policies.kyverno.io/severity: "high"
    policies.kyverno.io/description: >-
      Ensures containers run as non-root users for security.
spec:
  validationFailureAction: Enforce
  rules:
    - name: check-run-as-non-root
      match:
        any:
          - resources:
              kinds:
                - Pod
                - Deployment
                - StatefulSet
                - DaemonSet
      validate:
        message: "Containers must run as non-root user (pod-level or container-level securityContext)"
        anyPattern:
          # Deployment/StatefulSet/DaemonSet with pod-level runAsNonRoot
          - spec:
              template:
                spec:
                  securityContext:
                    runAsNonRoot: true
          # Deployment/StatefulSet/DaemonSet with container-level runAsNonRoot
          - spec:
              template:
                spec:
                  containers:
                    - name: "*"
                      securityContext:
                        runAsNonRoot: true
          # Pod with pod-level runAsNonRoot
          - spec:
              securityContext:
                runAsNonRoot: true
          # Pod with container-level runAsNonRoot
          - spec:
              containers:
                - name: "*"
                  securityContext:
                    runAsNonRoot: true

---
apiVersion: kyverno.io/v1
kind: ClusterPolicy
metadata:
  name: require-read-only-root-filesystem
  annotations:
    policies.kyverno.io/title: "Require Read-Only Root Filesystem"
    policies.kyverno.io/category: "Security"
    policies.kyverno.io/severity: "medium"
    policies.kyverno.io/description: >-
      Enforces read-only root filesystem for all containers.
spec:
  validationFailureAction: Enforce
  rules:
    - name: check-read-only-rootfs
      match:
        any:
          - resources:
              kinds:
                - Pod
                - Deployment
                - StatefulSet
                - DaemonSet
              namespaces:
                - prod
      validate:
        message: "Consider using read-only root filesystem for enhanced security"
        anyPattern:
          # Deployment/StatefulSet/DaemonSet (has template)
          - spec:
              template:
                spec:
                  containers:
                    - name: "*"
                      securityContext:
                        readOnlyRootFilesystem: true
          # Pod (no template)
          - spec:
              containers:
                - name: "*"
                  securityContext:
                    readOnlyRootFilesystem: true

---
apiVersion: kyverno.io/v1
kind: ClusterPolicy
metadata:
  name: require-resource-limits
  annotations:
    policies.kyverno.io/title: "Require Resource Limits"
    policies.kyverno.io/category: "Resource Management"
    policies.kyverno.io/severity: "medium"
    policies.kyverno.io/description: >-
      Ensures all containers have resource requests and limits defined.
spec:
  validationFailureAction: Enforce
  rules:
    - name: check-resource-limits
      match:
        any:
          - resources:
              kinds:
                - Pod
                - Deployment
                - StatefulSet
                - DaemonSet
      validate:
        message: "All containers must have resource requests and limits"
        anyPattern:
          # Deployment/StatefulSet/DaemonSet (has template)
          - spec:
              template:
                spec:
                  containers:
                    - name: "*"
                      resources:
                        requests:
                          memory: "?*"
                          cpu: "?*"
                        limits:
                          memory: "?*"
                          cpu: "?*"
          # Pod (no template)
          - spec:
              containers:
                - name: "*"
                  resources:
                    requests:
                      memory: "?*"
                      cpu: "?*"
                    limits:
                      memory: "?*"
                      cpu: "?*"

---
apiVersion: kyverno.io/v1
kind: ClusterPolicy
metadata:
  name: disallow-privilege-escalation
  annotations:
    policies.kyverno.io/title: "Disallow Privilege Escalation"
    policies.kyverno.io/category: "Security"
    policies.kyverno.io/severity: "high"
    policies.kyverno.io/description: >-
      Prevents containers from escalating privileges.
spec:
  validationFailureAction: Enforce
  rules:
    - name: check-privilege-escalation
      match:
        any:
          - resources:
              kinds:
                - Pod
                - Deployment
                - StatefulSet
                - DaemonSet
      validate:
        message: "Privilege escalation must be disabled"
        anyPattern:
          # Deployment/StatefulSet/DaemonSet (has template)
          - spec:
              template:
                spec:
                  containers:
                    - name: "*"
                      securityContext:
                        allowPrivilegeEscalation: false
          # Pod (no template)
          - spec:
              containers:
                - name: "*"
                  securityContext:
                    allowPrivilegeEscalation: false

---
apiVersion: kyverno.io/v1
kind: ClusterPolicy
metadata:
  name: require-drop-all-capabilities
  annotations:
    policies.kyverno.io/title: "Require Drop All Capabilities"
    policies.kyverno.io/category: "Security"
    policies.kyverno.io/severity: "high"
    policies.kyverno.io/description: >-
      Ensures containers drop all capabilities by default, with exceptions for specific needs.
spec:
  validationFailureAction: Audit
  rules:
    - name: check-capabilities
      match:
        any:
          - resources:
              kinds:
                - Pod
                - Deployment
                - StatefulSet
                - DaemonSet
      validate:
        message: "Containers should drop all capabilities (exceptions allowed with justification)"
        anyPattern:
          # Deployment/StatefulSet/DaemonSet (has template)
          - spec:
              template:
                spec:
                  containers:
                    - name: "*"
                      securityContext:
                        capabilities:
                          drop:
                            - ALL
          # Pod (no template)
          - spec:
              containers:
                - name: "*"
                  securityContext:
                    capabilities:
                      drop:
                        - ALL
